name: build_scan_push_deploy

on:
  push:
    branches: ["main"]
    paths:
      - "app/**"
      - "k8s/**"
      - ".github/workflows/app.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-2
  ECR_REPO: cloud4future-node
  K8S_NAMESPACE: app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # Checkout
      # ------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------
      # AWS OIDC Auth
      # ------------------------
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ------------------------
      # ECR Login
      # ------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ------------------------
      # Ensure ECR Repo Exists
      # ------------------------
      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories \
            --repository-names $ECR_REPO \
            --region $AWS_REGION \
          || aws ecr create-repository \
            --repository-name $ECR_REPO \
            --region $AWS_REGION

      # ------------------------
      # Build Image
      # ------------------------
      - name: Build Docker image
        run: |
          IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${ECR_REPO}:${{ github.sha }}"
          docker build -t "$IMAGE_URI" ./app
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      # ------------------------
      # Trivy (report-only)
      # ------------------------
      - name: Trivy scan (report only)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_URI }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 0

      # ------------------------
      # Push Image
      # ------------------------
      - name: Push image to ECR
        run: |
          docker push "$IMAGE_URI"

      # ------------------------
      # kubectl
      # ------------------------
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      # ------------------------
      # kubeconfig
      # ------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name "${{ secrets.EKS_CLUSTER_NAME }}" \
            --region "${{ secrets.AWS_REGION }}"

      # ------------------------
      # Deploy to EKS (Fargate safe)
      # ------------------------
      - name: Deploy to EKS
        run: |
          kubectl apply -f k8s/namespace.yaml --validate=false
          kubectl apply -f k8s/serviceaccount.yaml --validate=false

          sed "s|REPLACE_IMAGE|${IMAGE_URI}|g" k8s/deployment.yaml \
            | kubectl apply -f - --validate=false

          kubectl apply -f k8s/service.yaml --validate=false
          kubectl apply -f k8s/pdb.yaml --validate=false || true
          kubectl apply -f k8s/hpa.yaml --validate=false || true

          kubectl rollout status deployment/cloud4future-node \
            -n $K8S_NAMESPACE --timeout=300s

      # ------------------------
      # Output
      # ------------------------
      - name: Show service
        run: |
          kubectl get svc -n $K8S_NAMESPACE
